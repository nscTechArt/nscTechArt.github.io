---
title: URP中实现实时面光源
date: 2023-08-01 09:40 +0800
categories: [Unity, Rendering]
media_subpath: /assets/img/Unity/rendering
tag: [Unity]
math: true
---
### 1 Motivation

[Cozy Space](https://store.steampowered.com/app/2524480/Cozy_Space/)是一个装修模拟类游戏。它具有以下特点：

- 灵活的房间户型设计：玩家可以构建任意的多边形房间
- 时间/天气系统：玩家可以修改游戏中的时间段与天气，从而影响房间内的光照与氛围
- 自由的家具摆放：玩家可以自由地摆放房间中的家具、装饰品

基于以下几点考虑，我最终选择使用实时面光源作为房间中的主要光照来源：

- 平行光不适合作为封闭室内的照明来源，而更适合配合窗户和窗帘，营造室内氛围
- 由于房间户型是相对任意的，对于较为复杂的房间（例如一个1x6的走廊），点光源和聚光灯无法提供较好的照明效果
- 游戏中的所有家具都是可以自由拖放的，不存在静态对象，意味着不能使用光照烘焙等技术
- 基于LTC的实时面光源技术能够配合PBR材质着色，与项目美术资产不冲突，能够实现高质量的室内照明

---

## 2 实现原理

LTC的核心思想是：

1. **将复杂的BRDF积分转换为简单的余弦分布积分**
2. **通过线性变换矩阵（3x3矩阵）建立两个分布之间的映射关系**
3. **预计算所有可能的参数组合存储到纹理（LUT）**

我们假设原始分布为各向同性GGX模型，通过线性变换矩阵$M$将其转换到余弦分布：


$$
D_o(\omega_o)=\frac{D(M^{-1}\omega_o)}{|M|\cdot (M^{-T}\omega_0)_z}
$$


其中：

- $D_o$是变换后的余弦分布
- $|M|$为矩阵的行列式
- $(M^{-T}\omega_o)_z$是变换后向量在Z轴的分量

![](areaLightBounds.png)
