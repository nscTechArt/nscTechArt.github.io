---
title: 1.2 Photorealistic Rendering and the Ray-Tracing Algorithm
date: 2024-07-02 12:15 +0800
categories: [Graphics, Physically Based Rendering]
media_subpath: /assets/img/Graphics/PhysicallyBasedRendering/
math: true
---

在计算机图形学的领域中，光通常被建模为沿着射线传播的粒子，这也成为了光线追踪技术的基础。

从概念上来看，光线追踪是一种很简单的算法。它基于跟踪光线在场景中与环境中的物体进行相互作用并弹射的路径。尽管实现光线追踪的方法有很多种，但所有的光线追踪器都能够模拟出以下概念与现象：

- **Camera**：
  - 相机的模型决定了我们如何观察以及从哪里观察场景，包括场景的图像如何记录在传感器中
  - 相机在很多渲染系统中，同样是构建观察光线的起点
- **Ray-Object Intersections**：
  - 我们必须能够精确地判断给定光线与给定几何物体的相交位置
  - 除了位置，我们还需要确定相交处的物体的某些属性，如法线、材质
  - 大多数ray tracer都具有测试光线与多个物体相交的功能，这种情况下，ray tracer通常会返回沿光线方向距离相机最近的点
- **Light Sources**：
  - ray tracer必须对场景中的光线分布进行建模，即包括光源自身的位置，同时也包括光线在空间中分布能量的方式
- **Visibility**：
  - 为了确定给定的光是否在表面上的某一点传递能量，我们必须知道从该点到光源是否有一条不间断的路径，这也是光线追踪中一个相当基础的问题
- **Light Scattering As Surfaces**：
  - 每个物体都必须提供其外观的描述，例如光如何与该物体表面进行交互、光线会如何被散射
  - 表面散射的模型必须实现参数化，以便能够模拟各种外观
- **Indirect Light Transport**：
  - 因为光线可以通过反射或穿过其他物体到达物体的表面，ray tracer需要追踪额外的光线来捕捉这种效果
- **Ray Propagation**：
  - 我们需要了解光线在空间中传播时会发生什么
  - 我们通常会假定光线在真空中传播，但也有一些更复杂的模型，如烟、雾、地球大气层等

接下来，我们会更为详细地讨论以上的每个部分。

### 1.2.1 Cameras amd Film

最简单的相机模型是针孔相机，它由一个端部有一个小孔的不透光盒子构成。当小孔被打开时，光线进入盒子内，并落在盒子另一端的照片纸上，如下图所示：

![](pha01f02.svg)
_Figure 1.2  A Pinhole Camera_

相机最重要的一个功能是定义出场景中的哪些部分会被记录在胶片上。在图1.2中，我们可以看到针孔与胶片的边缘共同创建了一个延伸到了场景中的金字塔，金字塔以外的部分将无法出现在胶片上。但我们也不能认为金字塔中的部分就一定会被记录下来，相机实际的成像形状要远比金字塔复杂，因此，我们将可能成像到胶片上的空间命名为*viewing volume*

当然，我们也可以将胶片放在针孔与场景之中，但保持胶片与针孔之间的距离不变，如图1.3所示。这两种方式所构建的viewing volume是完全相同的。虽然这不是构建真是相机的方法，但是对于ray tracer而言，这是模拟相机的一个不错的选择，后面我们会意识到原因。此外，当胶片放在针孔前面时，我们可以称针孔为眼睛。

![](pha01f03.svg)
_图 1.3_

现在我们来讨论一个渲染中的关键问题：在图像的每个点上，如果确定相机要记录什么颜色？这个问题的答案部分取决于场景中的哪些部分在该点上是可见的。我们回想图1.2中的针孔相机模型，很显然，只有沿着针孔与胶片上一点所对应的射线传播的光线才是我们应该考虑的。

因此，相机模拟的一个重要任务是，取图像上一点并构建对应的入射光线。对于图1.3中的相机模型而言，这个任务相当简单，光线将以眼睛为原点，以眼睛到成像平面的向量作为方向。

到达相机的沿射线的亮光通常会携带不同波长的不同能量。人类视觉系统将这种波长变化解释为颜色。大多数相机传感器为对应于红色、绿色和蓝色的三个波长分布记录单独的测量值，这足以向人类观察者重建场景的视觉外观。（第 4.6 节更详细地讨论了颜色。）因此，相机中还包括一个胶片抽象，它既存储图像，又模拟胶片传感器对入射光的响应。

到达相机的光通常会携带不同波长的不同能量。人类视觉系统将这种波长变化解释为颜色。大多数相机传感器为对应于红色、绿色和蓝色的三个波长分布记录单独的测量值，这足以向人类观察者重建场景的视觉外观。因此，相机模型还包括一个抽象的“胶片”，它既存储图像，又模拟胶片传感器对入射光的响应。

### 1.2.2 Ray-Object Intersections

每次相机生成一条光线时，渲染器的首要任务就是判断哪个物体会光线首先相交，以及相交点的位置。这个相交点就是光线上的可见点，我们希望模拟出光线在该点上与物体的相互作用。为了找到相交点，我们需要测试光线与场景中物体的相交情况下，并选择出与光线首先相交的物体。

给定一条光线，我们可以用参数形式来表示：


$$
r(t)=o+td
$$


其中，$o$是光线原点，$d$是光线的方向向量，$t$则是一个范围为$[0, \infty)$的参数。通常来说，如果物体能够使用隐式方程来表示，那么我们可以通过将光线的参数方程代入的方式来计算$t$，从而得到相交点的位置。

仅有相交点来说是远远不够的，ray tracer还需要知道该点处表面的某些属性。首先，必须确定该点处材料的表示形式，并将其传递给射线追踪算法的后续阶段。其次，还需要有关交点的其他几何信息才能对该点进行着色。例如，表面法线总是必需的。尽管许多ray tracer仅使用法线，但像**pbrt**这样的更复杂的渲染系统甚至需要更多信息，例如关于表面局部参数化的位置和表面法线的各种偏导数。

当然，大多数场景由多个对象组成。暴力方法是依次测试射线与每个对象，选择所有交点的最小正值以找到最接近的交点。这种方法虽然正确，但非常慢，即使对于复杂度适中的场景也是如此。所以更好的办法是引入加速结构，从而在相交测试中能够快速剔除整组对象。使用加速结构能够让ray tracer的运行时的时间复杂度降至$O(m log n)$，其中m是图像中的像素数，n是场景中物体数量，但都构建加速结构本身的时间复杂度必然是$O(n)$。

### 1.2.3 Light Distribution

光线-物体的相交测试阶段会提供给我们要着色的点，以及该点处几何体的一些信息。回想一下，我们的最终目标是计算从该点沿着相机方向发出的光量。为此，我们需要知道有多少光能够到达该点。这将同时涉及到光在场景中的几何分布与辐射分布。

对于比较简单的光源来说（如点光源），光的几何分布我们只需要知道它的位置，然而点光源在现实世界中并不存在，因为基于物理的照明通常使用的光源是面光源，也就是说，光源会与一个物物体联立在一起，并从表面发出照明。这部分比较复杂，所以我们暂时还是用点光源来讨论光的分布。

假设我们想要计算被传递到相交点$p$周围的微分表面上的光量，如图1.5所示。

首先，点光源的功率为$\Phi$，并且它会向所有方向均匀地辐射能量。这意味着光源周围的单位球体上的单位面积上的功率为$\Phi / (4\pi)$

![](pha01f05.svg)
_图 1.5_

如果我们考虑有两个这样的球体，如图1.6所示，很明显，较大球体上某点的单位面积功率必须小于较小球体上某点的功率，因为相同的总功率分布在更大的面积上。具体来说，到达半径为$r$的球体上某点的单位面积功率与$1/r^2$成正比

![](pha01f06.svg)

_图1.6_

此外，可以证明如果一个微小表面$dA$相对于从表面上一点到光源的向量倾斜了一个$\theta$的角度，则传递到该表面上的功率与$cos\theta$成正比。我们将上述结论综合起来，得到单位面积$dE$上的微分功率（也就是微分辐照度）为：


$$
dE=\frac{\Phi cos\theta}{4\pi r^2}
$$


如果我们对计算机图形学略有了解的话，我们可以从上面这条公式中发现两个熟悉的定律：倾斜表面的余弦衰减定律和平放反比衰减定律

对于包含了多个光源的场景来说，由于光照是“线性”的，我们可以分别计算每个光源对于场景照明的贡献值，然后求和。这里的“线性”的含义是：可以应用复杂的算法从场景中每个着色点的部分光源随机采样光照

### 1.2.4 Visiblity

前一节我们对于光照分布的描述中，忽略了一个重要的部分：阴影。幸运的是，在光线追踪器中，很容易确定光线是否从被着色的点可见。我们只需构建一条新光线，其原点位于表面点，其方向指向光线。这些特殊光线称为阴影光线。如果我们通过环境追踪这条光线，我们可以检查是否在光线的原点和光源之间找到任何交点，方法是将找到的任何交点的参数值与光源位置光线上的参数值进行比较。如果光线和表面之间没有遮挡物体，则包括光线的贡献。

### 1.2.5 Light Scattering as Surfaces

我们现在能够计算出对于一个点的正确着色至关重要的两条信息：它的位置和入射光照。现在我们需要确定入射光找如何在表面上散射。具体来说，我们需要计算的是在该点上向相机方向散射的光量。

![](pha01f09.svg)
_图 1.9_

场景中的每个物体都有一个材质，它描述了表面在每个点上外观的属性。此描述由双向反射分布函数提供，BRDF告诉我们从入射方向$w_i$反射到到出射方向$w_o$的能量有多少。我们通常将BRDF表述为$f_r(p,w_o,w_i)$，其中$w$均代表单位向量。

### 1.2.6 Indirect Lights Transport

Turner Whitted提出了光线追踪的递归的性质，这使得渲染间接镜面反射和投射成为可能。

总的来说，从物体上一点P到达相机的光量，可以从该点处反射到相机的光与物体（如果是自发光物体）所发出的光的总和得出。我们将这个概念提炼为light transport公式，或者用一个大家更为熟悉的名字：渲染方程。

渲染方程使用radiance这样一个辐射学单位来测量光量。在渲染方程中，点P在出射方向ω<sub>o</sub>上的出射radiance记为L<sub>o</sub>，L<sub>o</sub>等于点P在ω<sub>o</sub>方向上的自发光加上P点处的球体上所有方向上的入射radiance，且入射radiance受BRDF与余弦值影响：
$$
L_0(p, \omega_o)=L_e(p, w_o)+ \int_{S^2}f(p, w_o, w_i)L_i(p, w_i)|cos\theta _i|d\omega_i
$$
我们会在后续的章节中推导渲染方程。除了最简单的场景以外，渲染方程不可能通过解析求解，因为我们需要简化方程或者使用数值积分的技术。

而Turner Whitted的光线追踪的算法中，就忽略了来自大多数方向的入射光，而是只考虑了光源的方向以及完美反射与折射方向，从而将积分转换为少数方向上的求和。

当然，在我们将要实现的渲染器中，我们将使用随机抽样的算法来解决简化渲染方程。

### 1.2.7 Ray Propagation

目前为止，我们都假设的是光线在真空中传播。比如我们在讨论点光源的光分布时，就假设功率是各个方向上是均匀分布的，并不会在传播途中减少。但在现实中，烟雾、灰尘等空气中的介质可能会让我们的假设失效，这些效应对于模拟是很重要的。

介质影响光传播的方式有两种：

- 介质通过吸收或散射来衰减光。我们可以通过计算光线原点与相交点之间的透射率来模拟这种效果。
- 介质也可以沿着光线增强光。比如介质是发光的的（火焰），或介质会将其他方向的光散射到当前的光的方向上。我们可以通过数值计算*volume light transport方程*来计算增加的光量。

