---
title: 2.2 Improving Efficiency
date: 2024-07-04 15:58 +0800
categories: [Graphics, Physically Based Rendering]
tags: [Monte Carlo]
media_subpath: /assets/img/Graphics/PhysicallyBasedRendering/
math: true
---

通过上一篇博客，我们已经找到了在蒙特卡洛方法中采样数量与方差之间的关系。如果在渲染中，我们得到了一个噪点过多的图像，增加采样数量就可以以一种可预测的方式减少误差，从而在足够的时间内生成质量足够高的图像。但是计算通常也会需要大量的时间，这同样是一种成本。

所以，在样本数量有限的情况下，减少方差的唯一方法就是充分利用已经采集到的样本。接下来，我们来讨论一下在pbrt中运用到的重要技术。

### 2.2.1 Stratified Sampling

在蒙特卡洛方法中，适当地调整采样策略可以更好地捕捉被积函数的特征，或者更准确的来说，是可以减少错过重要特征的可能性。其中一种重要的策略就是分层采样。分层采样将积分域分为若干区域，并且在每个区域内放置采样点，从而更好地覆盖整个采样空间，提高近似的精度。在本小节中，我们将从方差减少的角度来分析这种方法。

分层采样将积分域$\Lambda$细分为$n$个不重叠的区域$\Lambda_1, \Lambda_2,...,\Lambda_n$，我们将每个区域称为一个层*stratum*，并且所有层必须可以完全覆盖原始积分域：


$$
\bigcup_{i=1}^n \Lambda_i=\Lambda
$$


为了从积分域$\Lambda$中采样，我们将该区域划分为若干个分层$\Lambda_i$，并且在每个分层内根据密度$p_i$抽取$n_i$个样本。一个简单的例子是对像素进行超采样。当对一个像素使用分层采样时，像素的面积会被划分为$k \times k$个网格，然后我们会在每个网格单元内均匀抽取一个样本。这种做法比直接从整个像素面积上随机抽取$k^2$个样本更好，因为分层采样会让样本位置不容易聚集在一起。

对于一个单一分层$\Lambda_i$，蒙特卡洛估值器的定义如下：


$$
F_i=\frac{1}{n_i}\sum_{j=1}^{n_i}\frac{f(X_{i,j})}{p(X_{i,j})}
$$


其中，$X_{i,j}$是从分层$\Lambda_i$中抽取的第$j$个样本，$f(X_{i,j})$是我们需要近似的函数值，而$p_i(X_{i,j})$是采样点的概率密度。

对于整个区域的蒙特卡洛估值器自然是所有分层的近似的加权和：


$$
F=\sum_i v_iF_i
$$


之所以是加权和，是因为对于每个分层的近似值，我们还需要乘以对应分层的体积占比，即$v_i$

接下来，我们来考虑分层采样的方差问题。首先，分层$\Lambda_i$内的真实值为：


$$
\mu_i=E[f(X_{i,j})]=\frac{1}{v_i}\int_{\Lambda_i}f(x)dx
$$


则我们可以表示出分层$\Lambda_i$的方差为：


$$
\sigma_i^2=\frac{1}{v_i}\int_{\Lambda_i}(f(x)-\mu_i)^2dx
$$


也就是说，在每个分层中抽取$n_i$个样本时，分层估值器的方差为$\sigma_i^2 / n$，则整个域上的估值器的方差为：


$$
\begin{aligned}
V[F]
& = V\Big[\sum v_i F_i\Big] \\
& = \sum V[v_iF_i] \\
& = \sum v_i^2V[F_i] \\
& = \sum \frac{v_i^2\sigma_i^2}{n_i}
\end{aligned}
$$


如果我们做出合理的假设，即样本数$n_i$与体积$v_i$成正比，那么我们有$n_i=v_in$，其中$n$是总样本数。那么方差就可以进一步推导为：


$$
V[F] = \sum \frac{v_i^2\sigma_i^2}{n_i} = \frac{1}{n}\sum_iv_i\sigma_i^2
$$


当我们选择不分层采样时，我们直接从整个积分域$\Lambda$中抽取样本，这意味着每个样本都可能来自于$\Lambda$的任何部分，而非特定的分层。

为了理解不分层采样的方差，我们可以将不分层的采样视为分层采样中的一种特殊情况。根据分层的体积$v_i$定义的离散概率分布选择一个随机分层$I$，然后从该分层的域$\Lambda_I$中选择一个随机样本$X$。这种情况下，抽样可以理解为在条件$I$下选择样本。

所以，我们可以通过条件概率来表示总体方差：


$$
V[F]=\frac{1}{n}\Big[ \sum_i v_i\sigma_i^2 + \sum_i v_i(\mu_i-Q)^2 \Big]
$$


其中，$Q$是整个域$\Lambda$上$f$的均值。我们可以分两部分来理解这个方差公式：

- **第一部分**：$\frac{1}{n}\sum_i v_i\sigma_i^2$
  - 这一部分是分成采样下每个分层的方差加权和
  - 它描述了分层内的方差对于整体方差的贡献
- **第二部分**：$\frac{1}{n}\sum_i v_i(\mu_i-Q)^2$
  - 这一部分是每个分层均值与总体均值的偏差平方和
  - 它描述了分层之间的差异对于整体方差的影响

我们通过分析方差公式可以得到如下结论：

- **分层采样总是减少方差**，除非第二部分（即分层间差异的影响）为零。这种情况仅在$f$在每个分层$\Lambda_i$的均值相同时出现
- 为了使得分层效果最佳，我们希望尽可能最大化公式右侧第二项的值。因此，在理想情况下，分层应该尽量使得每个分层内的均值尽可能不同。
- 这也是为什么紧凑的分层（即均匀且具有较小内部变异的分层）是理想的。如果分层较宽，则它们会包含更多的变异，分层均值会更接近于总体均值$Q$

最终我们可以得到一个结论，分层采样不仅可以有效减少估计结果的方差，还可以提高收敛速度。只是，这种优势会随着维度的提升而减小。这是因为**高维空间中的样本均匀分布变得更加困难，且采样的复杂度显著增加。**网格数量会随着维度的增加呈指数级增长，这显著增加了计算和存储的负载度。

### 2.2.2 Importance Sampling
